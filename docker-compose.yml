services:
  Traefik:
    image: traefik:latest
    container_name: traefik
    command:
        - '--api.insecure=true'
        - '--providers.consulcatalog=true'
        - '--providers.consulcatalog.prefix=traefik'
        - '--providers.consulcatalog.endpoint.address=consul:8500'
        - '--serversTransport.insecureSkipVerify=true'
        - '--entryPoints.web.address=:80'
        - '--entryPoints.developer_api.address=:8081'
        - '--log.level=DEBUG'
    ports:
      - 80:80
      - 8081:8081
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      # - ./traefik.yaml:/etc/traefik/traefik.yaml
    networks:
      - Pro290_network
    restart: always

  Consul:
    image: hashicorp/consul:latest
    container_name: consul
    command: "agent -dev -client=0.0.0.0"
    ports:
      - "8500:8500"
    networks:
      - Pro290_network
    labels:
      - 'traefik.enable=true'
      - 'traefik.consulcatalog.connect=true'
    restart: unless-stopped

  RabbitMQ:
    image: rabbitmq
    container_name: rabbitmq
    networks:
      - Pro290_network
    ports:
      - "5672:5672"
      - "15672:15672"

  UserService:
    image: user_service
    build: /user_service
    environment:
      - API_ADDRESS=0.0.0.0
      - USER_URL=postgres://David:Password123@userdatabase:5432/users
      - IMAGE_URL=postgres://David:Password123@imagedatabase:5432/images
      - RABBIT_URL=amqp://rabbitmq
      - SECRET_KEY=idkmanwhatdoyouwantfrommeDav
    networks:
      - Pro290_network
    depends_on:
      - Consul
    restart: unless-stopped

  RabbitConsumer:
    image: rabbit_consumer
    build: /consumer
    environment:
      - EMAIL=zomhorsethompson2656@gmail.com
      - PASSWORD=zkzb vevz esul frjt 
      - RABBIT_URL=amqp://rabbitmq
    networks:
      - Pro290_network
    restart: unless-stopped

  UserDatabase:
    image: postgres
    container_name: userdatabase
    hostname: userdatabase
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: David
      POSTGRES_PASSWORD: Password123
      POSTGRES_DB: users
    networks:
      - Pro290_network

  pgadmin4:
    image: dpage/pgadmin4
    container_name: pgadmin
    ports:
      - "5050:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin_password
    networks:
      - Pro290_network

networks:
  Pro290_network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.25.0.0/16